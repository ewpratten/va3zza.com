<!DOCTYPE html>
<html lang="en">

<head>
    



    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-KFJ95RP');</script>
    <!-- End Google Tag Manager -->

    

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/jpg" href="https:&#x2F;&#x2F;avatars.githubusercontent.com&#x2F;u&#x2F;21065412" />
    
    <link rel="canonical" href="https:&#x2F;&#x2F;ewpratten.com&#x2F;blog&#x2F;32u4-upload&#x2F;" />
    

    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://ewpratten.com/ rss.xml">
    <link rel="webmention" href="https://webmention.io/ewpratten.com/webmention" />
    <link rel="pingback" href="https://webmention.io/ewpratten.com/xmlrpc" />

    <title>
Flashing code to a 32u4 chip
 | Evan Pratten</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Urbanist:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://maxst.icons8.com">
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <link rel="stylesheet" href="/styles/layout.css">
    <link rel="stylesheet" href="/styles/project_mosaic.css">


    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"
        integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />


    <meta name="twitter:card" content="summary" />
    <meta name="og:site" content="ewpratten.com" />
    <meta name="og:image" content="https:&#x2F;&#x2F;avatars.githubusercontent.com&#x2F;u&#x2F;21065412" />
    <meta name="twitter:creator" content="@ewpratten">
    <meta name="og:site_name" content="Evan Pratten (VA3ZZA)" />

    






<meta property="og:title" content="Flashing code to a 32u4 chip - Evan Pratten" />
<meta property="og:type" content="article" />

<meta property="og:description" content="Notes for my future self" />
<meta property="description" content="Notes for my future self" />

<meta property="article:published_time" content="2020-06-05T00:00:00" />









<script type="application/ld+json">
    
    
    
    {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "url": "https://ewpratten.com/blog/32u4-upload/",
    "headline": "Flashing code to a 32u4 chip",
    "dateCreated": "2020-06-05T00:00:00",
    "datePublished": "2020-06-05T00:00:00",
    "dateModified": "2020-06-05T00:00:00",
    "inLanguage": "en-CA",
    "isFamilyFriendly": "true",
    "accountablePerson": {
        "@type": "Person",
        "name": "Evan Pratten",
        "url": "https://ewpratten.com"
    },
    "author": {
        "@type": "Person",
        "name": "Evan Pratten",
        "url": "https://ewpratten.com"
    },
    "creator": {
        "@type": "Person",
        "name": "Evan Pratten",
        "url": "https://ewpratten.com"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Evan Pratten",
        "url": "https://ewpratten.com",
        "logo": {
            "@type": "ImageObject",
            "url": "https://avatars.githubusercontent.com/u/21065412",
            "width": "460",
            "height": "460"
        }
    },
    "mainEntityOfPage": "True",
    "keywords": [],
    "genre": [],
    "articleSection": "Blog Post",
    "__articleBody__": "{{content}}"
}
</script>






</head>

<body>
    <div class="container">
        <div class="profile-card">
            
<div class="row">
    <div class="headshot-container">
        <img src="https:&#x2F;&#x2F;avatars.githubusercontent.com&#x2F;u&#x2F;21065412" alt="Headshot" style="height:50px;width:auto;">
    </div>
    <div class="text-container">
        <h1>Evan Pratten</h1>
        <p>
            Software Developer
        </p>
    </div>
</div>

        </div>
        <div class="navigation-bar">
            <hr>
            <p>
                <a href="/">Home</a> |
                <a href="/blog">Blog</a> |
                
                
                
                <a href="/contact">Contact</a>
                
                
                
            </p>
            <hr>
        </div>
        <div class="page-content">
            
<br><br>
<article class="markdown-body">
    
    <h1 style="border:none;margin-bottom:0;padding-bottom:0">Flashing code to a 32u4 chip</h1>
    <h3 style="margin-top:0;color:gray;padding-bottom:.3em;border-bottom:1px solid #eaecef;">
        <em>
            <span style="color:rgb(186, 186, 186)">/*</span>
            Notes for my future self
            <span style="color:rgb(186, 186, 186)">*/</span>
        </em>
    </h3>
    
    <div style="text-align: justify;">
        <p>The <a rel="noopener" target="_blank" href="http://ww1.microchip.com/downloads/en/devicedoc/atmel-7766-8-bit-avr-atmega16u4-32u4_datasheet.pdf">ATmega32u4</a> (aka. 32u4) chip is one of my favorite microcontrollers to work with. It is a low power, 8-bit, <a rel="noopener" target="_blank" href="https://en.wikipedia.org/wiki/AVR_microcontrollers">AVR</a>-based system developed by <a rel="noopener" target="_blank" href="https://en.wikipedia.org/wiki/Atmel">Atmel</a>. They are commonly used in <a rel="noopener" target="_blank" href="https://www.arduino.cc/en/Main/Arduino_BoardLeonardo">Arduino Leonardo</a> development boards and programmed via the <a rel="noopener" target="_blank" href="https://www.arduino.cc/en/Main/Software">Arduino IDE</a>, but I prefer having as much control over the device as I can. So I choose to program these chips directly in <a rel="noopener" target="_blank" href="http://ww1.microchip.com/downloads/en/devicedoc/40001917a.pdf">AVRASM</a> and <a rel="noopener" target="_blank" href="https://www.nongnu.org/avr-libc/user-manual/">AVR-C</a>.</p>
<p>This post will go over how to easily flash code to a 32u4 chip from a Linux host, and exists as reference for when I inevitably need to refresh my memory in the future.</p>
<h2 id="getting-the-needed-tools">Getting the needed tools</h2>
<p>Before starting, the following tools are needed:</p>
<ul>
<li><a rel="noopener" target="_blank" href="https://github.com/vancegroup-mirrors/avr-libc/releases">AVR-libc</a></li>
<li><a rel="noopener" target="_blank" href="https://www.nongnu.org/avrdude/">avrdude</a></li>
</ul>
<h2 id="writing-a-hello-world-for-avr">Writing a &quot;Hello, world!&quot; for AVR</h2>
<p>Since you can't exactly &quot;print to console&quot; with a microprocessor, this &quot;Hello, world!&quot; will consist of toggling one of the 32u4's I/O pins once every half second. In this case, we will write to <code>PB5</code> (pin <code>9</code> on an Arduino Leonardo). If you don't understand how AVR code works, I recommend reading a simple tutorial. This program simply configures <code>DDRB</code> to allow output for <code>PB5</code>, and toggles the <code>PB5</code> bit in <code>PORTB</code> every 500ms.</p>
<pre data-lang="cpp" style="background-color:#2b303b;color:#c0c5ce;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#65737e;">// main.cc
</span><span>
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">avr/io.h</span><span>&gt;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">util/delay.h</span><span>&gt;
</span><span>
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span>(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span>, </span><span style="color:#b48ead;">char const</span><span>* </span><span style="color:#bf616a;">argv</span><span>[]) {
</span><span>
</span><span>    DDRB |= (</span><span style="color:#d08770;">1 </span><span>&lt;&lt; PB5); 
</span><span>    </span><span style="color:#b48ead;">for </span><span>(;;) {
</span><span>        PORTB= </span><span style="color:#d08770;">0b00100000</span><span>;
</span><span>        </span><span style="color:#bf616a;">_delay_ms</span><span>(</span><span style="color:#d08770;">500</span><span>); 
</span><span>        PORTB= </span><span style="color:#d08770;">0b00000000</span><span>; 
</span><span>        </span><span style="color:#bf616a;">_delay_ms</span><span>(</span><span style="color:#d08770;">500</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span>;
</span><span>}
</span></code></pre>
<h2 id="compiling">Compiling</h2>
<p>This code can now be compiled with:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">avr-g++ -DF_CPU</span><span>=16000000</span><span style="color:#bf616a;"> -D</span><span> __AVR_ATmega32U4__</span><span style="color:#bf616a;"> -mmcu</span><span>=atmega32u4</span><span style="color:#bf616a;"> -Iinclude -DBAUD</span><span>=9600</span><span style="color:#bf616a;"> -std</span><span>=c++11</span><span style="color:#bf616a;"> -g -Os -w -fdata-sections -MMD -flto -c -o</span><span> main.o main.cc
</span></code></pre>
<p>And linked with:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">avr-g++ -w -Os -g -flto -fuse-linker-plugin -Wl</span><span>,--gc-sections</span><span style="color:#bf616a;"> -mmcu</span><span>=atmega32u4</span><span style="color:#bf616a;"> -Iinclude -std</span><span>=c++11</span><span style="color:#bf616a;"> -DF_CPU</span><span>=16000000</span><span style="color:#bf616a;"> -o</span><span> main.elf main.o
</span><span style="color:#bf616a;">avr-objcopy -O</span><span> ihex</span><span style="color:#bf616a;"> -j</span><span> .eeprom</span><span style="color:#bf616a;"> --set-section-flags</span><span>=.eeprom=alloc,load</span><span style="color:#bf616a;"> --no-change-warnings --change-section-lma</span><span> .eeprom=0 main.elf main.eep
</span><span style="color:#bf616a;">avr-objcopy -O</span><span> ihex</span><span style="color:#bf616a;"> -R</span><span> .eeprom main.elf main.hex
</span></code></pre>
<p>To create a HEX file for the program binary, and an eeprom dump. These are both going to be uploaded to the chip in the next step.</p>
<h2 id="flashing-the-32u4">Flashing the 32u4</h2>
<p>The 32u4 chip must be in it's bootloader in order to have it's memory written. This can be done in one of two ways. The first (my preference) is to quickly reset the chip before running avrdude by pulling the <code>RST</code> line to ground. You can also put the chip in it's bootloader by connecting to UART at <code>1200bps</code>. Once in the bootloader, the chip will stay there for 10 seconds.</p>
<p>WIth the 32u4 in it's bootloader, we can flash our compiled code with:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">sudo</span><span> avrdude</span><span style="color:#bf616a;"> -patmega32u4 -cavr109 -P</span><span> /dev/ttyACM0</span><span style="color:#bf616a;"> -b57600 -v -U</span><span> flash:w:main.hex:i</span><span style="color:#bf616a;"> -U</span><span> eeprom:w:main.eep
</span></code></pre>
<p><em>NOTE: <code>/dev/ttyACM0</code> may need to be changed depending on the system</em></p>
<p>Once the code has uploaded, reset the chip to start the code.</p>

    </div>

    
    
    <br>
    <hr>
    <script src="https://utteranc.es/client.js" repo="ewpratten/va3zza.com" issue-term="title" label="comment"
        theme="github-light" crossorigin="anonymous" async>
        </script>
    

</article>




        </div>

        <div id="footer">
            <p class="gray">-- EOF --</p>
            <p>
                <em>
                    <a href="https://github.com/ewpratten/va3zza.com"><i class="lab la-github"></i></a>
                    <a href="https://status.ewpratten.com"><i class="las la-info-circle"></i></a>
                    <a href="/rss.xml"><i class="las la-rss"></i></a><br>

                    Thanks for reading :)<br>
                    Site design & content by: <a href="/info">Evan Pratten</a><br>
                    Consider <a href="/donate" target="_blank">supporting my work</a> if you like what you see<br>

                </em>
            </p>
        </div>
    </div>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5912H4H03P"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-5912H4H03P');
    </script>

    <script>
        if (window.performance && performance.getEntriesByType) { // avoid error in Safari 10, IE9- and other old browsers
            let navTiming = performance.getEntriesByType('navigation')
            if (navTiming.length > 0) { // still not supported as of Safari 14...
                let serverTiming = navTiming[0].serverTiming
                if (serverTiming && serverTiming.length > 0) {
                    for (let i = 0; i < serverTiming.length; i++) {
                        if (serverTiming[i].name == 'source') {
                            if (serverTiming[i].description == 'net44') {
                                document.getElementById('ampr-notice').style.display = 'block';
                            }
                        }
                    }
                }
            }
        }
    </script>

    
    <script>
        if (window.location.hostname == 'retrylife.ca') {
            window.location.href = window.location.href.replace('retrylife.ca', 'ewpratten.com');
        }
    </script>

    
    <a rel="me" href="https://social.ewpratten.com/@evan" style="display:none;"></a>
</body>

</html>